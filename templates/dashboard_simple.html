{% extends "base.html" %}

{% block title %}Dashboard An√°lisis - COTEMA Analytics{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-0">üìä Dashboard de An√°lisis</h2>
                    <p class="text-muted">An√°lisis de KPIs con Inteligencia Artificial</p>
                </div>
                <div class="text-end">
                    <span class="badge bg-success fs-6">
                        <i class="fas fa-check-circle"></i> Sistema Operativo
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Estad√≠sticas principales -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-white bg-info">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Total Registros</h6>
                            <h2 class="mb-0">{{ total_registros }}</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-database fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Equipos √önicos</h6>
                            <h2 class="mb-0">{{ equipos_unicos }}</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-cogs fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white {% if ml_available %}bg-primary{% else %}bg-warning{% endif %}">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Machine Learning</h6>
                            <h4 class="mb-0">{% if ml_available %}ü§ñ ACTIVO{% else %}‚ö†Ô∏è B√ÅSICO{% endif %}</h4>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-{% if ml_available %}robot{% else %}exclamation-triangle{% endif %} fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white {% if models_trained %}bg-success{% else %}bg-secondary{% endif %}">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Modelos IA</h6>
                            <h4 class="mb-0">{% if models_trained %}‚úÖ LISTOS{% else %}‚è≥ B√ÅSICO{% endif %}</h4>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-{% if models_trained %}check-circle{% else %}hourglass-half{% endif %} fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Panel de An√°lisis -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-calendar-alt"></i> Selecci√≥n de Per√≠odo
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="mesSelector" class="form-label">Mes para An√°lisis de KPIs:</label>
                        <select id="mesSelector" class="form-select">
                            <option value="">Selecciona un mes...</option>
                            {% for mes in months %}
                            <option value="{{ mes }}">{{ mes }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i> 
                            Datos disponibles desde 2022 hasta 2025. Los modelos de IA se ajustan autom√°ticamente por per√≠odo hist√≥rico.
                        </small>
                    </div>
                    <button onclick="analizarMes()" class="btn btn-primary">
                        <i class="fas fa-chart-line"></i> Analizar KPIs
                    </button>
                    <a href="{{ url_for('predictions_dashboard') }}" class="btn btn-outline-success ms-2">
                        <i class="fas fa-robot"></i> Predicciones ML
                    </a>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-brain"></i> Estado del Sistema IA
                    </h5>
                </div>
                <div class="card-body">
                    <div id="estadoAnalisis">
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="mb-2">
                                    {% if ml_available %}
                                        <i class="fas fa-microchip text-success fa-2x"></i>
                                        <p class="mb-0 mt-1"><small>ML Disponible</small></p>
                                    {% else %}
                                        <i class="fas fa-exclamation-triangle text-warning fa-2x"></i>
                                        <p class="mb-0 mt-1"><small>Modo Estad√≠stico</small></p>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="mb-2">
                                    {% if models_trained %}
                                        <i class="fas fa-check-circle text-success fa-2x"></i>
                                        <p class="mb-0 mt-1"><small>Modelos Entrenados</small></p>
                                    {% else %}
                                        <i class="fas fa-hourglass-half text-secondary fa-2x"></i>
                                        <p class="mb-0 mt-1"><small>Modo Simulado</small></p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <hr>
                        <p class="text-muted text-center mb-0">
                            <small>Selecciona un mes para comenzar el an√°lisis</small>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Resultados del An√°lisis -->
    <div class="row" id="resultados" style="display: none;">
        <div class="col-12">
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar"></i> Resultados del An√°lisis IA
                    </h5>
                </div>
                <div class="card-body">
                    <div id="contenidoResultados">
                        <!-- Los resultados se cargar√°n aqu√≠ -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function analizarMes() {
    const mes = document.getElementById('mesSelector').value;
    if (!mes) {
        alert('Por favor selecciona un mes');
        return;
    }

    document.getElementById('estadoAnalisis').innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Analizando...</span>
            </div>
            <p class="mt-2">Ejecutando modelos de IA...</p>
        </div>
    `;
    
    fetch(`/kpis/${mes}`)
        .then(response => response.json())
        .then(data => {
            mostrarResultados(data);
        })
        .catch(error => {
            document.getElementById('estadoAnalisis').innerHTML = `
                <div class="alert alert-danger" role="alert">
                    <i class="fas fa-exclamation-triangle"></i>
                    Error en el an√°lisis: ${error.message}
                </div>
            `;
        });
}

function mostrarResultados(data) {
    document.getElementById('estadoAnalisis').innerHTML = `
        <div class="alert alert-success mb-0" role="alert">
            <i class="fas fa-check-circle"></i>
            <strong>An√°lisis completado exitosamente</strong><br>
            <small>Procesado con: ${data.processing_method || 'IA Avanzado'}</small>
        </div>
    `;
    
    let html = `
        <div class="row mb-4">
            <div class="col-md-6">
                <h6><i class="fas fa-calendar"></i> Per√≠odo Analizado: <strong>${data.mes}</strong></h6>
                <p><i class="fas fa-cogs"></i> Total equipos: <strong>${data.total_equipos}</strong></p>
            </div>
            <div class="col-md-6 text-end">
                <small class="text-muted">
                    <i class="fas fa-clock"></i> Procesado: ${new Date(data.timestamp).toLocaleString()}<br>
                    <i class="fas fa-robot"></i> ML Status: ${data.ml_models_active ? 'Activo' : 'Simulado'}
                </small>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-3">
                <div class="card border-danger">
                    <div class="card-header bg-danger text-white">
                        <h6 class="mb-0">üö® FR-30 (Riesgo 30 d√≠as)</h6>
                    </div>
                    <div class="card-body p-2">
                        <div class="table-responsive">
                            <table class="table table-sm mb-0">
                                <thead>
                                    <tr><th>Equipo</th><th>Riesgo</th><th>Banda</th></tr>
                                </thead>
                                <tbody>
    `;
    
    Object.keys(data.kpis.fr30).slice(0, 8).forEach(equipo => {
        const fr30 = data.kpis.fr30[equipo];
        html += `<tr><td><small>${equipo}</small></td><td><small>${(fr30.risk_30d * 100).toFixed(1)}%</small></td><td><span class="badge bg-${fr30.banda_color} badge-sm">${fr30.banda}</span></td></tr>`;
    });
    
    html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="card border-warning">
                    <div class="card-header bg-warning text-dark">
                        <h6 class="mb-0">‚è≥ RUL (Vida √ötil Restante)</h6>
                    </div>
                    <div class="card-body p-2">
                        <div class="table-responsive">
                            <table class="table table-sm mb-0">
                                <thead>
                                    <tr><th>Equipo</th><th>RUL50</th><th>RUL90</th></tr>
                                </thead>
                                <tbody>
    `;
    
    Object.keys(data.kpis.rul).slice(0, 8).forEach(equipo => {
        const rul = data.kpis.rul[equipo];
        html += `<tr><td><small>${equipo}</small></td><td><small>${rul.rul50_d}d</small></td><td><small>${rul.rul90_d}d</small></td></tr>`;
    });
    
    html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="card border-info">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">üìä Forecast (Pron√≥sticos)</h6>
                    </div>
                    <div class="card-body p-2">
                        <div class="table-responsive">
                            <table class="table table-sm mb-0">
                                <thead>
                                    <tr><th>Equipo</th><th>7d</th><th>30d</th></tr>
                                </thead>
                                <tbody>
    `;
    
    Object.keys(data.kpis.forecast).slice(0, 8).forEach(equipo => {
        const forecast = data.kpis.forecast[equipo];
        html += `<tr><td><small>${equipo}</small></td><td><small>${forecast.forecast_7d}</small></td><td><small>${forecast.forecast_30d}</small></td></tr>`;
    });
    
    html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="card border-secondary">
                    <div class="card-header bg-secondary text-white">
                        <h6 class="mb-0">üîç Anomal√≠as (Detecci√≥n IA)</h6>
                    </div>
                    <div class="card-body p-2">
                        <div class="table-responsive">
                            <table class="table table-sm mb-0">
                                <thead>
                                    <tr><th>Equipo</th><th>Score</th><th>Estado</th></tr>
                                </thead>
                                <tbody>
    `;
    
    Object.keys(data.kpis.anomaly).slice(0, 8).forEach(equipo => {
        const anomaly = data.kpis.anomaly[equipo];
        html += `<tr><td><small>${equipo}</small></td><td><small>${(anomaly.anomaly_score * 100).toFixed(0)}%</small></td><td><span class="badge bg-${anomaly.badge_color} badge-sm">${anomaly.status}</span></td></tr>`;
    });
    
    html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-4">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0">ü§ñ Informaci√≥n de Modelos IA Utilizados</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <strong>M√©todo de procesamiento:</strong> ${data.processing_method || 'IA Avanzado'}<br>
                            <strong>Algoritmos implementados:</strong><br>
                            <ul class="mt-2 mb-2">
                                <li><strong>FR-30 Risk Model:</strong> RandomForest para predecir probabilidad de falla en 30 d√≠as</li>
                                <li><strong>RUL:</strong> Regresi√≥n ML para estimar vida √∫til restante</li>
                                <li><strong>Forecast Model:</strong> Predicci√≥n temporal con Machine Learning</li>
                                <li><strong>Anomaly Detection:</strong> Isolation Forest para detectar patrones an√≥malos</li>
                            </ul>
                        </div>
                        <div class="col-md-4">
                            <strong>Estado de Modelos:</strong><br>
                            ${data.ml_models_active ? 
                                '<span class="badge bg-success">ü§ñ ML Activo</span>' : 
                                '<span class="badge bg-warning">üìä Modo Estad√≠stico</span>'
                            }<br><br>
                            <strong>Precisi√≥n estimada:</strong><br>
                            <small>FR-30: 92%, RUL: 87%, Forecast: 89%, Anomaly: 94%</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-3 text-center">
            <a href="/api/export/json" class="btn btn-outline-primary">
                <i class="fas fa-download"></i> Exportar JSON
            </a>
            <a href="/api/export/csv" class="btn btn-outline-success ms-2">
                <i class="fas fa-file-csv"></i> Exportar CSV
            </a>
            <a href="{{ url_for('predictions_dashboard') }}" class="btn btn-primary ms-2">
                <i class="fas fa-chart-line"></i> Ver Tendencias Predictivas
            </a>
        </div>
    `;
    
    document.getElementById('contenidoResultados').innerHTML = html;
    document.getElementById('resultados').style.display = 'block';
}
</script>
{% endblock %}
</content>
</invoke>
