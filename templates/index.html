{% extends "base.html" %}

{% block title %}COTEMA - Inicio{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="jumbotron bg-light p-5 rounded">
                <h1 class="display-4">
                    <i class="fas fa-tools text-primary"></i>
                    COTEMA - Análisis Predictivo de Taller
                </h1>
                <p class="lead">
                    Servicio web para análisis de KPIs predictivos basados en inteligencia artificial.
                    Analiza patrones de fallas, calcula riesgo de reincidencia y optimiza el mantenimiento.
                </p>
                <hr class="my-4">
                <p>
                    Carga tu archivo Excel con los registros de ingresos al taller y obtén análisis avanzados
                    incluyendo FR-30, RUL, pronósticos de uso y detección de anomalías.
                </p>
            </div>
        </div>
    </div>

    {% if not data_loaded %}
    <!-- Upload Section -->
    <div class="row mb-4">
        <div class="col-md-8 mx-auto">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-upload"></i>
                        Cargar Archivo Excel
                    </h5>
                </div>
                <div class="card-body">
                    <form action="{{ url_for('upload_file') }}" method="post" enctype="multipart/form-data" id="uploadForm">
                        <div class="mb-3">
                            <label for="file" class="form-label">
                                <strong>Selecciona el archivo Excel con los datos del taller:</strong>
                            </label>
                            <input type="file" class="form-control" id="file" name="file" accept=".xlsx,.xls" required>
                            <div class="form-text">
                                Formatos soportados: .xlsx, .xls (máximo 50MB)
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <h6>Columnas requeridas en el archivo:</h6>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-check text-success"></i> <strong>CODIGO</strong> - Código del equipo</li>
                                <li><i class="fas fa-check text-success"></i> <strong>FECHA_IN</strong> - Fecha de ingreso al taller</li>
                                <li><i class="fas fa-check text-success"></i> <strong>FECHA_OUT</strong> - Fecha de salida del taller</li>
                                <li><i class="fas fa-info-circle text-info"></i> <strong>SISTEMA_AFECTADO</strong> - Sistema que presentó la falla (opcional)</li>
                                <li><i class="fas fa-info-circle text-info"></i> <strong>FLOTA</strong> - Tipo de flota (opcional)</li>
                                <li><i class="fas fa-info-circle text-info"></i> <strong>CLASE</strong> - Clase del equipo (opcional)</li>
                            </ul>
                        </div>
                        
                        <button type="submit" class="btn btn-primary btn-lg" id="uploadBtn">
                            <i class="fas fa-upload"></i>
                            Cargar y Procesar Datos
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Modal de Progreso de Carga -->
    <div class="modal fade" id="progressModal" tabindex="-1" aria-labelledby="progressModalLabel" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="progressModalLabel">
                        <i class="fas fa-upload fa-spin"></i>
                        Cargando Archivo Excel
                    </h5>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span id="currentTask" class="fw-bold">Iniciando carga...</span>
                            <span id="progressPercent" class="badge bg-primary">0%</span>
                        </div>
                        <div class="progress mb-3" style="height: 25px;">
                            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-success" 
                                 role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                            </div>
                        </div>
                        <div id="progressMessage" class="text-muted">
                            <i class="fas fa-info-circle"></i>
                            Preparando para cargar tu archivo...
                        </div>
                    </div>

                    <!-- Pasos del proceso - solo carga -->
                    <div class="row">
                        <div class="col-12">
                            <h6 class="mb-3">Progreso de Carga:</h6>
                            <div class="list-group">
                                <div class="list-group-item d-flex align-items-center" id="step-1">
                                    <div class="step-icon me-3">
                                        <i class="fas fa-circle-notch fa-spin text-primary" style="display:none;"></i>
                                        <i class="fas fa-check-circle text-success" style="display:none;"></i>
                                        <i class="fas fa-circle text-muted"></i>
                                    </div>
                                    <div>
                                        <div class="fw-bold">1. Validando archivo</div>
                                        <small class="text-muted">Verificando formato y contenido</small>
                                    </div>
                                </div>
                                <div class="list-group-item d-flex align-items-center" id="step-2">
                                    <div class="step-icon me-3">
                                        <i class="fas fa-circle-notch fa-spin text-primary" style="display:none;"></i>
                                        <i class="fas fa-check-circle text-success" style="display:none;"></i>
                                        <i class="fas fa-circle text-muted"></i>
                                    </div>
                                    <div>
                                        <div class="fw-bold">2. Guardando archivo</div>
                                        <small class="text-muted">Almacenando datos de manera segura</small>
                                    </div>
                                </div>
                                <div class="list-group-item d-flex align-items-center" id="step-3">
                                    <div class="step-icon me-3">
                                        <i class="fas fa-circle-notch fa-spin text-primary" style="display:none;"></i>
                                        <i class="fas fa-check-circle text-success" style="display:none;"></i>
                                        <i class="fas fa-circle text-muted"></i>
                                    </div>
                                    <div>
                                        <div class="fw-bold">3. Cargando en memoria</div>
                                        <small class="text-muted">Preparando datos para análisis</small>
                                    </div>
                                </div>
                                <div class="list-group-item d-flex align-items-center" id="step-4">
                                    <div class="step-icon me-3">
                                        <i class="fas fa-circle-notch fa-spin text-primary" style="display:none;"></i>
                                        <i class="fas fa-check-circle text-success" style="display:none;"></i>
                                        <i class="fas fa-circle text-muted"></i>
                                    </div>
                                    <div>
                                        <div class="fw-bold">4. Archivo listo</div>
                                        <small class="text-muted">Listo para seleccionar tipo de análisis</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="errorSection" class="alert alert-danger mt-3" style="display: none;">
                        <h6><i class="fas fa-exclamation-triangle"></i> Error en el procesamiento</h6>
                        <p id="errorMessage"></p>
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="hideProgressModal()">
                            Cerrar y reintentar
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <div id="successSection" style="display: none;">
                        <button type="button" class="btn btn-success" onclick="redirectToDashboard()">
                            <i class="fas fa-chart-line"></i>
                            Ir al Dashboard
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if data_loaded %}
    <!-- Data Status Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-success" role="alert">
                <h4 class="alert-heading">
                    <i class="fas fa-check-circle"></i>
                    ¡Datos Cargados Exitosamente!
                </h4>
                <p>
                    Los datos han sido procesados y están listos para el análisis.
                    Fecha de procesamiento: <strong>{{ processed_date.strftime('%d/%m/%Y a las %H:%M:%S') }}</strong>
                </p>
                <hr>
                <div class="row">
                    <div class="col-md-6">
                        <a class="btn btn-success" href="{{ url_for('dashboard') }}">
                            <i class="fas fa-chart-line"></i>
                            Ver Dashboard
                        </a>
                        <button class="btn btn-outline-primary" onclick="showUploadForm()">
                            <i class="fas fa-refresh"></i>
                            Cargar Nuevos Datos
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Features Section -->
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="fas fa-brain"></i>
                Modelos de Inteligencia Artificial Disponibles
            </h2>
        </div>
        
        <div class="col-md-6 mb-3">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title text-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        FR-30 - Riesgo de Falla
                    </h5>
                    <p class="card-text">
                        Calcula la probabilidad de que un equipo reingrese al taller en los próximos 30 días
                        usando HistGradientBoostingClassifier calibrado.
                    </p>
                    <ul class="list-unstyled text-muted">
                        <li>• Análisis de patrones temporales</li>
                        <li>• Evaluación de reincidencia por sistema</li>
                        <li>• Clasificación en bandas de riesgo</li>
                        <li>• Probabilidades calibradas 0-100%</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 mb-3">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title text-info">
                        <i class="fas fa-clock"></i>
                        RUL - Vida Útil Restante
                    </h5>
                    <p class="card-text">
                        Estima cuántos días le quedan al equipo antes de la próxima falla
                        usando modelos de supervivencia Weibull.
                    </p>
                    <ul class="list-unstyled text-muted">
                        <li>• RUL-50 (mediana) y RUL-90 (conservador)</li>
                        <li>• Modelos parametrizados por clase</li>
                        <li>• Recomendaciones de ventana de mantenimiento</li>
                        <li>• Análisis de supervivencia avanzado</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 mb-3">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title text-success">
                        <i class="fas fa-chart-line"></i>
                        Pronóstico de Uso
                    </h5>
                    <p class="card-text">
                        Predice las horas de operación futuras en 7 y 30 días
                        usando Prophet con análisis de estacionalidad.
                    </p>
                    <ul class="list-unstyled text-muted">
                        <li>• Proyecciones a 7 y 30 días</li>
                        <li>• Análisis de estacionalidad semanal</li>
                        <li>• Integración con RUL para programación</li>
                        <li>• Recomendaciones para scheduler</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 mb-3">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title text-warning">
                        <i class="fas fa-search"></i>
                        Detección de Anomalías
                    </h5>
                    <p class="card-text">
                        Detecta patrones operativos atípicos que preceden fallas
                        usando Isolation Forest.
                    </p>
                    <ul class="list-unstyled text-muted">
                        <li>• Early warning de comportamientos anómalos</li>
                        <li>• Análisis de ventanas temporales</li>
                        <li>• Evaluación multidimensional</li>
                        <li>• Alertas preventivas</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Integration Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-plug"></i>
                        Integración con Herramientas de BI
                    </h5>
                </div>
                <div class="card-body">
                    <p>
                        Este servicio puede integrarse con herramientas de Business Intelligence
                        como Power BI, Tableau, Qlik Sense, etc.
                    </p>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Endpoints de API Disponibles:</h6>
                            <ul>
                                <li><code>/api/connection-test</code> - Test de conectividad</li>
                                <li><code>/kpis/&lt;mes&gt;</code> - KPIs por mes</li>
                                <li><code>/api/export/csv</code> - Exportar CSV</li>
                                <li><code>/api/export/json</code> - Exportar JSON</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>Formatos de Salida:</h6>
                            <ul>
                                <li>JSON estructurado para APIs</li>
                                <li>CSV para importación directa</li>
                                <li>Gráficos embebibles</li>
                                <li>Datos en tiempo real</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <a href="/api/connection-test" class="btn btn-outline-secondary" target="_blank">
                            <i class="fas fa-heartbeat"></i>
                            Probar Conexión
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Instructions Section -->
    <div class="row">
        <div class="col-12">
            <div class="accordion" id="instructionsAccordion">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingInstructions">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInstructions">
                            <i class="fas fa-question-circle me-2"></i>
                            Instrucciones de Uso
                        </button>
                    </h2>
                    <div id="collapseInstructions" class="accordion-collapse collapse" data-bs-parent="#instructionsAccordion">
                        <div class="accordion-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Paso 1: Preparar los Datos</h6>
                                    <ul>
                                        <li>Organiza tu archivo Excel con las columnas requeridas</li>
                                        <li>Asegúrate de que las fechas estén en formato válido</li>
                                        <li>Incluye datos de al menos 3 meses para mejores resultados</li>
                                    </ul>
                                    
                                    <h6>Paso 2: Cargar el Archivo</h6>
                                    <ul>
                                        <li>Usa el formulario de carga en esta página</li>
                                        <li>El sistema validará y procesará automáticamente</li>
                                        <li>Recibirás confirmación del número de registros procesados</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6>Paso 3: Analizar los Resultados</h6>
                                    <ul>
                                        <li>Ve al Dashboard para explorar los datos</li>
                                        <li>Selecciona el mes de análisis para calcular KPIs</li>
                                        <li>Revisa las recomendaciones y explicaciones IA</li>
                                    </ul>
                                    
                                    <h6>Paso 4: Exportar e Integrar</h6>
                                    <ul>
                                        <li>Exporta los resultados en CSV o JSON</li>
                                        <li>Conecta herramientas de BI usando las APIs</li>
                                        <li>Programa actualizaciones regulares</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden upload form for reload -->
<div id="reloadUploadForm" class="modal fade" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cargar Nuevos Datos</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form action="{{ url_for('upload_file') }}" method="post" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="newFile" class="form-label">Seleccionar nuevo archivo:</label>
                        <input type="file" class="form-control" id="newFile" name="file" accept=".xlsx,.xls" required>
                    </div>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Nota:</strong> Cargar nuevos datos reemplazará los datos actuales.
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-upload"></i>
                        Cargar
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 COTEMA Analytics - DOM loaded');
    
    // Verificar que los elementos existen
    const uploadForm = document.getElementById('uploadForm');
    const uploadBtn = document.getElementById('uploadBtn');
    const progressModal = document.getElementById('progressModal');
    
    console.log('Form found:', !!uploadForm);
    console.log('Button found:', !!uploadBtn);
    console.log('Modal found:', !!progressModal);
    
    if (!uploadForm) {
        console.error('❌ Upload form not found!');
        return;
    }
    
    // Manejar envío del formulario de upload
    uploadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        console.log('📤 Form submitted, starting upload process...');
        
        const formData = new FormData(this);
        
        // Mostrar modal de progreso
        showProgressModal();
        
        // Iniciar monitoreo de progreso
        startProgressMonitoring();
        
        // Enviar archivo
        fetch('/upload', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            // Verificar si la respuesta es JSON antes de parsear
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.indexOf("application/json") !== -1) {
                return response.json();
            } else {
                // Si no es JSON, es un error HTML (como el 500 Internal Server Error)
                return response.text().then(text => {
                    throw new Error("El servidor devolvió una respuesta inesperada (no JSON).");
                });
            }
        })
        .then(data => {
            if (data.success) {
                showSuccessCompletion(data);
            } else {
                showError(data.error || 'Error desconocido en el procesamiento');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('Error de conexión: ' + error.message);
        });
    });
    
    let progressInterval;
    
    function showProgressModal() {
        const modal = new bootstrap.Modal(document.getElementById('progressModal'));
        modal.show();
        resetProgressSteps();
    }
    
    function hideProgressModal() {
        const modal = bootstrap.Modal.getInstance(document.getElementById('progressModal'));
        if (modal) {
            modal.hide();
        }
        if (progressInterval) {
            clearInterval(progressInterval);
        }
    }
    
    function startProgressMonitoring() {
        progressInterval = setInterval(updateProgress, 500); // Actualizar cada 500ms
        updateProgress(); // Actualización inmediata
    }
    
    function updateProgress() {
        fetch('/api/progress')
            .then(response => response.json())
            .then(data => {
                updateProgressBar(data.progress);
                updateCurrentTask(data.current_task, data.message);
                updateProgressSteps(data.current_step, data.total_steps);
                
                if (data.error) {
                    showError(data.error);
                } else if (!data.is_processing && data.progress === 100) {
                    // El procesamiento se completó exitosamente
                    clearInterval(progressInterval);
                }
            })
            .catch(error => {
                console.error('Error monitoring progress:', error);
            });
    }
    
    function updateProgressBar(progress) {
        const progressBar = document.getElementById('progressBar');
        const progressPercent = document.getElementById('progressPercent');
        
        progressBar.style.width = progress + '%';
        progressBar.setAttribute('aria-valuenow', progress);
        progressPercent.textContent = progress + '%';
        
        if (progress === 100) {
            progressBar.classList.remove('progress-bar-striped', 'progress-bar-animated');
            progressBar.classList.add('bg-success');
        }
    }
    
    function updateCurrentTask(task, message) {
        document.getElementById('currentTask').textContent = task || 'Procesando...';
        document.getElementById('progressMessage').innerHTML = 
            '<i class="fas fa-info-circle"></i> ' + (message || 'Trabajando en el proceso...');
    }
    
    function updateProgressSteps(currentStep, totalSteps) {
        for (let i = 1; i <= 4; i++) {  // Solo 4 pasos ahora
            const stepElement = document.getElementById(`step-${i}`);
            const icons = stepElement.querySelectorAll('.step-icon i');
            const [spinIcon, checkIcon, defaultIcon] = icons;
            
            // Ocultar todos los iconos
            icons.forEach(icon => icon.style.display = 'none');
            
            if (i < currentStep) {
                // Paso completado
                checkIcon.style.display = 'inline';
                stepElement.classList.add('list-group-item-success');
            } else if (i === currentStep) {
                // Paso actual
                spinIcon.style.display = 'inline';
                stepElement.classList.add('list-group-item-primary');
            } else {
                // Paso pendiente
                defaultIcon.style.display = 'inline';
                stepElement.classList.remove('list-group-item-success', 'list-group-item-primary');
            }
        }
    }
    
    function resetProgressSteps() {
        for (let i = 1; i <= 4; i++) {  // Solo 4 pasos ahora
            const stepElement = document.getElementById(`step-${i}`);
            const icons = stepElement.querySelectorAll('.step-icon i');
            const [spinIcon, checkIcon, defaultIcon] = icons;
            
            // Mostrar solo el icono por defecto
            icons.forEach(icon => icon.style.display = 'none');
            defaultIcon.style.display = 'inline';
            
            // Remover clases de estado
            stepElement.classList.remove('list-group-item-success', 'list-group-item-primary', 'list-group-item-danger');
        }
        
        // Ocultar secciones de error y éxito
        document.getElementById('errorSection').style.display = 'none';
        document.getElementById('successSection').style.display = 'none';
    }
    
    function showError(errorMessage) {
        clearInterval(progressInterval);
        
        document.getElementById('errorMessage').textContent = errorMessage;
        document.getElementById('errorSection').style.display = 'block';
        
        // Actualizar barra de progreso para mostrar error
        const progressBar = document.getElementById('progressBar');
        progressBar.classList.remove('bg-success', 'progress-bar-striped', 'progress-bar-animated');
        progressBar.classList.add('bg-danger');
        
        document.getElementById('currentTask').textContent = 'Error en el procesamiento';
        document.getElementById('progressMessage').innerHTML = 
            '<i class="fas fa-exclamation-triangle"></i> Se produjo un error durante el procesamiento.';
    }
    
    function showSuccessCompletion(data) {
        clearInterval(progressInterval);
        
        // Completar todos los pasos
        updateProgressSteps(5, 4);  // 5 para completar el paso 4
        updateProgressBar(100);
        
        document.getElementById('currentTask').textContent = 'Archivo cargado exitosamente';
        document.getElementById('progressMessage').innerHTML = 
            '<i class="fas fa-check-circle text-success"></i> ' + data.message;
        
        // Mostrar botón de éxito
        document.getElementById('successSection').style.display = 'block';
        
        // Auto-redirigir después de 3 segundos
        setTimeout(() => {
            redirectToDashboard();
        }, 3000);
    }
    
    function redirectToDashboard() {
        window.location.href = '/dashboard';
    }
    
    function showUploadForm() {
        const modal = new bootstrap.Modal(document.getElementById('reloadUploadForm'));
        modal.show();
    }
    
}); // Cierre del DOMContentLoaded
</script>
{% endblock %}
